(function(n,t,i,r){function v(n,i){if(i)if(t.isArray(n))t.observable.track(n,{beforeChange:i.beforeChange,afterChange:i.afterChange,afterEvent:i.afterEvent});else{if(t.inArray("_getObservable",Object.getOwnPropertyNames(n))>=0)throw"Entities added via Upshot/JS must not previously have been treated with WinJS.Binding.as";var r=new c(n,i.beforeChange,i.afterChange,i.afterEvent);r.backingData=n,Object.defineProperty(n,"_getObservable",{value:function(){return r},enumerable:!1,writable:!1})}else delete n._getObservable}function a(n,i,r){return function(){var u={change:"insert",index:i,items:r};t([n]).triggerHandler("arrayChange",u)}}function p(n,i,r){return function(){var u={change:"remove",index:i,items:r};t([n]).triggerHandler("arrayChange",u)}}function y(n,i,r){return function(){var u={change:"refresh",oldItems:i,newItems:r};t([n]).triggerHandler("arrayChange",u)}}function h(n,t,r,u){var f=i.Binding.as(n);return function(){f._notifyListeners(t,u,r)}}var l=i.Binding.as({}).constructor,s=l.prototype,c=i.Class.derive(s,function(n,t,i,r){s.constructor.call(this,n),this._beforeChange=t,this._afterChange=i,this._afterEvent=r},{updateProperty:function(n,t){var o=this._backingData[n],e=i.Binding.unwrap(t),r,f,u;return o!==e?(r={path:n,value:t},this._beforeChange&&this._beforeChange(this._backingData,"propertyChange",r),this._backingData[n]=e,this._afterChange&&this._afterChange(this._backingData,"propertyChange",r),f=this._notifyListeners(n,e,o),u=this._afterEvent,u?f.then(function(){u(this._backingData,"propertyChange",r)}):f):i.Promise.as()}}),f=r.defineNamespace("upshot.observability"),e,o;f.winjs={track:v,createInsertDeferredEvent:a,createRemoveDeferredEvent:p,createRefreshDeferredEvent:y,createSetPropertyDeferredEvent:h},f.configuration=f.winjs,e=i.Class.define(function(n){var i;i=n.applyLocalQuery?t.dataSource.unwrapHack(n.getEntities()):n,this._dataSource=i,this._dataSourceObserver=null,this._arrayChangeHandler=null,this.compareByIdentity=!0},{dispose:function(){this._dataSource&&(this._dataSource.removeObserver(this._dataSourceObserver),t([this._dataSource.getEntities()]).unbind("arrayChange",this._arrayChangeHandler),this._dataSource=null)},setNotificationHandler:function(n){function r(r,u){var f;n.beginNotifications();switch(u.change){case"refresh":n.invalidateAll();break;case"insert":var o=i._dataSource.getEntities(),e=f===0?null:o[f-1],s=f===o.length-1?null:o[f+1];f=u.index,t.each(u.items,function(){var t={key:i._getEntityKey(this),data:this};n.inserted(t,e&&i._getEntityKey(e),s&&i._getEntityKey(s),f),e=this,f++});break;case"remove":f=u.index,t.each(u.items,function(){n.removed(i._getEntityKey(this),f)});break;case"move":default:throw"Unexpected array changed event.";}n.endNotifications()}var i=this;this._dataSourceObserver={propertyChanged:function(t){n.changed({key:i._getEntityKey(t),data:t})}},this._dataSource.addObserver(this._dataSourceObserver),this._arrayChangeHandler=r,t([this._dataSource.getEntities()]).bind("arrayChange",r)},itemsFromIndex:function(n,r,u){var e=n-r,h=r+1+u,f=this._dataSource.getEntities(),s=f.slice(e,e+h),o=this;return i.Promise.wrap({items:t.map(s,function(n){return{key:o._getEntityKey(n),data:n}}),offset:r,totalCount:f.length,absoluteIndex:n})},getCount:function(){return i.Promise.wrap(this._dataSource.getEntities().length)},_getEntityKey:function(n){return this._dataSource.getEntityId(n)}}),o=i.Class.define(function(n){var i,t;this._dataContext=n.dataContext,this._dataContext||(n.bufferChanges||(t=this,i=function(){t._dataContext._commitChanges({providerParameters:t._providerParameters})}),this._dataContext=new r.DataContext(new r.riaDataProvider,i)),this._providerParameters=n.providerParameters,this._entityType=n.entityType,this._lastTotalCount=null,this._notificationHandler=null,this._entitySet=null,this._entitySetObserver=null,this._arrayChangeHandler=null,this._sort=null,this._filters=null,this._setFilter=r.RemoteDataSource.prototype.setFilter,this._processFilter=r.DataSource.prototype._processFilter,this.compareByIdentity=!0},{entitySet:{get:function(){return this._entitySet}},filter:{set:function(n){this._setFilter(n)}},sort:{set:function(n){this._sort=n}},refresh:function(){this._notificationHandler.invalidateAll()},dispose:function(){this._entitySet&&(this._entitySet.removeObserver(this._entitySetObserver),t([this._entitySet.getEntities()]).unbind("arrayChange",this._arrayChangeHandler),this._entitySet=null)},setNotificationHandler:function(n){this._notificationHandler=n},itemsFromIndex:function(n,r,u){var f=this;return new i.Promise(function(i){var h=n-r,s=r+1+u,o=function(u){var e={items:t.map(u,function(n){return{key:f._getEntityKey(n),data:n}}),offset:r,totalCount:f._lastTotalCount,absoluteIndex:n};i(e)};f._loadEntities(h,s,o)})},getCount:function(){if(this._lastTotalCount!==null)return i.Promise.wrap(this._lastTotalCount);var n=this;return new i.Promise(function(t){n._loadEntities(null,0,function(){t(n._lastTotalCount)})})},_loadEntities:function(n,t,i,r){var u=this,e=function(n,t,r){u._bindToEntitySet(n),u._lastTotalCount=r,i&&i.call(u,t)},f=function(n,t){r&&r.call(u,n,t)};this._dataContext.__load({providerParameters:this._providerParameters,entityType:this._entityType,queryParameters:{filters:this._filters,sort:this._sort,skip:n,take:t,includeTotalCount:!0}},e,f)},_bindToEntitySet:function(n){function r(n,r){i._notificationHandler.beginNotifications();switch(r.change){case"insert":break;case"remove":t.each(r.items,function(){i._notificationHandler.removed(i._getEntityKey(this))});break;case"move":case"refresh":default:throw"Unexpected array changed event.";}i._notificationHandler.endNotifications()}if(this._entitySet)return;this._entitySet=n;var i=this;this._entitySetObserver={propertyChanged:function(n){i._notificationHandler.changed({key:i._getEntityKey(n),data:n})}},n.addObserver(this._entitySetObserver),this._arrayChangeHandler=r,t([n.getEntities()]).bind("arrayChange",r)},_getEntityKey:function(n){return this._entitySet.getEntityId(n)}}),i.Namespace.define("upshot.WinJS",{DataSource:function(n){var r=new e(n),t=new i.UI.ListDataSource(r);return t.dispose=function(){r.dispose()},t},VirtualizingDataSource:function(n){var r=new o(n),t=new i.UI.ListDataSource(r);return Object.defineProperty(t,"filter",{set:function(n){r.filter=n}}),Object.defineProperty(t,"sort",{set:function(n){r.sort=n}}),Object.defineProperty(t,"entitySet",{get:function(){return r.entitySet}}),t.refresh=function(){r.refresh()},t.dispose=function(){r.dispose()},t}})})(this,jQuery,WinJS,upshot);